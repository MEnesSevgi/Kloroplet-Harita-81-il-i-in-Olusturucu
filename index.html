<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>T√ºrkiye & D√ºnya Korolet Haritasƒ± - Dinamik Lejantlƒ±</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; display: flex; height: 100vh; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        #map { flex-grow: 1; height: 100%; background: #f4f4f4; }

        #dataPanel {
            width: 380px; background: #fff; padding: 20px;
            box-shadow: -2px 0 10px rgba(0,0,0,0.1); overflow-y: auto; z-index: 1001;
        }
        
        body.view-mode #dataPanel { display: none; }

        .control-group { border: 1px solid #eee; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #fafafa; }
        .province-entry { display: flex; align-items: center; margin-bottom: 8px; }
        .province-entry label { flex: 1; font-size: 0.85em; }
        .province-entry input { width: 80px; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }

        .range-entry { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .range-entry input { width: 100%; padding: 4px; border: 1px solid #ccc; border-radius: 4px; }

        .city-label {
            font-size: 10px; font-weight: bold; color: #333;
            text-shadow: 0 0 3px #fff; text-align: center;
            pointer-events: none !important; white-space: nowrap;
        }

        .btn { width: 100%; padding: 10px; border: none; border-radius: 5px; cursor: pointer; margin-bottom: 10px; font-weight: bold; transition: 0.3s; }
        .btn-update { background: #28a745; color: white; }
        .btn-share { background: #6f42c1; color: white; }
        .btn-download { background: #ffc107; color: #333; }
        .btn-upload { background: #17a2b8; color: white; }

        .color-option { display: inline-block; width: 25px; height: 25px; margin: 2px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; }
        .color-option.selected { border-color: #333; }

        /* Lejant Stili */
        .info.legend {
            padding: 10px; background: rgba(255,255,255,0.9);
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 5px; line-height: 24px; color: #555;
        }
        .info.legend i { width: 18px; height: 18px; float: left; margin-right: 8px; opacity: 0.7; border: 1px solid #999; }

        /* Yeni A√ßƒ±klama Paneli Stili (Sol Alt) */
        .info.description {
            padding: 15px; background: rgba(255,255,255,0.95);
            box-shadow: 0 0 15px rgba(0,0,0,0.2); border-radius: 8px; 
            min-width: 200px; color: #333;
        }
        .info.description h4 { margin: 0 0 10px 0; border-bottom: 2px solid #6f42c1; padding-bottom: 5px; }
        .info.description ul { list-style: none; padding: 0; margin: 0; }
        .info.description li { margin-bottom: 5px; font-size: 0.9em; display: flex; justify-content: space-between; }
        .info.description b { color: #2171b5; }
    </style>
</head>
<body>

<div id="map"></div>

<div id="dataPanel">
    <h2>üìä Harita Y√∂netimi</h2>
    
    <div class="control-group">
        <p>üìù <b>Panel Ayarlarƒ±</b></p>
        <label style="font-size: 0.8em;">A√ßƒ±klama Ba≈ülƒ±ƒüƒ±:</label>
        <input type="text" id="panelTitleInput" class="range-val" value="Harita A√ßƒ±klamalarƒ±" style="width:100%; margin-bottom:10px;">
        <button id="shareMap" class="btn btn-share">üîó Haritayƒ± Payla≈ü (G√∂r√ºn√ºm Linki)</button>
    </div>

    <div class="control-group">
        <p>üé® <b>Renk Aralƒ±klarƒ± & Palet</b></p>
        <div id="rangeInputs">
            <div class="range-entry"><input type="number" class="range-val" value="10"></div>
            <div class="range-entry"><input type="number" class="range-val" value="50"></div>
            <div class="range-entry"><input type="number" class="range-val" value="100"></div>
            <div class="range-entry"><input type="number" class="range-val" value="500"></div>
            <div class="range-entry"><input type="number" class="range-val" value="1000"></div>
        </div>
        <div id="colorPaletteSelector" style="margin-top:10px;"></div>
    </div>

    <div class="control-group">
        <p>üìÅ <b>Excel Veri Y√∂netimi</b></p>
        <button id="downloadTemplate" class="btn btn-download">1. ≈ûablon ƒ∞ndir</button>
        <button id="uploadData" class="btn btn-upload">2. Veri Y√ºkle (.xlsx)</button>
        <input type="file" id="excelFile" accept=".xlsx, .xls" style="display: none;">
    </div>

    <h3>üìç ƒ∞l Verileri</h3>
    <div id="provinceInputs"></div>
    <button id="updateButton" class="btn btn-update">Haritayƒ± G√ºncelle</button>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
    const map = L.map('map').setView([39, 35], 6);
    let currentData = {};
    let selectedPaletteKey = 'blue';
    let userRanges = [10, 50, 100, 500, 1000];
    let legendControl;
    let descriptionControl; // Sol alt panel i√ßin

    const PALETTES = {
        blue: ['#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'],
        red: ['#fee0d2','#fcbba1','#fc9272','#fb6a4a','#ef3b2c','#cb181d','#99000d'],
        green: ['#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'],
      purple: ['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#807dba','#6a51a3','#4a1486'],
    orange: ['#fff5eb','#fee6ce','#fdd0a2','#fdae6b','#fd8d3c','#f16913','#8c2d04'],
    magma:  ['#fcfdbf','#fec287','#fa8270','#cd4071','#8c2981','#51127c','#000004'],
      
      // Standart Renkler
        blue: ['#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'],
        red: ['#fee0d2','#fcbba1','#fc9272','#fb6a4a','#ef3b2c','#cb181d','#99000d'],
        green: ['#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'],
        
        // Ara Tonlar
        purple: ['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#807dba','#6a51a3','#4a1486'],
        orange: ['#fff5eb','#fee6ce','#fdd0a2','#fdae6b','#fd8d3c','#f16913','#8c2d04'],
        pink: ['#fde0ef','#f1b6da','#de77ae','#c51b7d','#8e0152','#4d004b','#270026'],
        
        // √áok Renkli (Sƒ±cak-Soƒüuk) Ge√ßi≈üler
        terrain: ['#ffffd4','#fed98e','#fe9929','#d95f0e','#993404','#632200','#3b1400'],
        sunset: ['#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#800026'],
        ocean: ['#e0f3db','#a8ddb5','#7bccc4','#4eb3d3','#2b8cbe','#0868ac','#084081'],
        
        // Koyu/Modern Temalar
        magma: ['#fb8861','#e65d6f','#b6367a','#822681','#541f81','#231151','#000004'],
        viridis: ['#fde725','#b5de2b','#6ece58','#35b779','#31688e','#443983','#440154'],
        gray: ['#f7f7f7','#d9d9d9','#bdbdbd','#969696','#737373','#525252','#252525'],
      
      // --- KLASƒ∞K SIRALI PALETLER ---
        blue:   ['#deebf7','#c6dbef','#9ecae1','#6baed6','#4292c6','#2171b5','#084594'],
        red:    ['#fee0d2','#fcbba1','#fc9272','#fb6a4a','#ef3b2c','#cb181d','#99000d'],
        green:  ['#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#238b45','#005a32'],
        purple: ['#f2f0f7','#dadaeb','#bcbddc','#9e9ac8','#807dba','#6a51a3','#4a1486'],
        orange: ['#fff5eb','#fee6ce','#fdd0a2','#fdae6b','#fd8d3c','#f16913','#8c2d04'],
        gray:   ['#f7f7f7','#d9d9d9','#bdbdbd','#969696','#737373','#525252','#252525'],

        // --- MODERN & PARLAK GE√áƒ∞≈ûLER ---
        sunset:  ['#ffeda0','#fed976','#feb24c','#fd8d3c','#fc4e2a','#e31a1c','#800026'],
        ocean:   ['#e0f3db','#a8ddb5','#7bccc4','#4eb3d3','#2b8cbe','#0868ac','#084081'],
        terrain: ['#ffffd4','#fed98e','#fe9929','#d95f0e','#993404','#632200','#3b1400'],
        forest:  ['#f7fcf5','#e5f5e0','#c7e9c0','#a1d99b','#74c476','#41ab5d','#00441b'],
        electric:['#fcfdbf','#fdbb2d','#f89b29','#ec6a1a','#cc4c02','#993404','#662506'],

        // --- Bƒ∞Lƒ∞MSEL VERƒ∞ PALETLERƒ∞ (PERCEPTUALLY UNIFORM) ---
        viridis: ['#fde725','#b5de2b','#6ece58','#35b779','#31688e','#443983','#440154'],
        magma:   ['#fb8861','#e65d6f','#b6367a','#822681','#541f81','#231151','#000004'],
        inferno: ['#fcffa4','#fac228','#f57d15','#d44842','#9f2a63','#65156e','#000004'],
        plasma:  ['#eff821','#f89441','#d44b73','#9b179e','#5d08a8','#0d0887','#000004'],

        // --- √áƒ∞FT Y√ñNL√ú (ZIT) PALETLER ---
        // (D√º≈ü√ºk ve y√ºksek deƒüerleri zƒ±t renklerle vurgulamak i√ßin harikadƒ±r)
        spectral:['#d53e4f','#fc8d59','#fee08b','#ffffbf','#e6f598','#99d594','#3288bd'],
        red_blue:['#b2182b','#ef8a62','#fddbc7','#f7f7f7','#d1e5f0','#67a9cf','#2166ac'],
        brown_teal:['#8c510a','#d8b365','#f6e8c3','#f5f5f5','#c7eae5','#5ab4ac','#01665e'],
        pink_green:['#8e0152','#c51b7d','#de77ae','#f1b6da','#e6f5d0','#a1d99b','#4d9221'],
        
        // --- √ñZEL KOMBƒ∞NASYON ---
        vintage: ['#eae2d6','#d5c3aa','#b99976','#906d48','#634b35','#423122','#2b1d12'],
      
      
      
      
      
    };

    // Katmanlar
    const osmLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '¬© OSM' });
    const worldLayer = L.layerGroup();
    const turkeyLayerGroup = L.layerGroup().addTo(map);

    L.control.layers(
        { "Sadece Harita": L.tileLayer('') },
        { "OpenStreetMap": osmLayer, "T√ºrkiye ƒ∞ller": turkeyLayerGroup, "D√ºnya Sƒ±nƒ±rlarƒ±": worldLayer }
    ).addTo(map);
    osmLayer.addTo(map);

    // D√ºnya Sƒ±nƒ±rlarƒ±nƒ± Y√ºkle
    fetch('https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson')
        .then(r => r.json()).then(data => {
            L.geoJSON(data, { style: { color: "#999", weight: 0.5, fillOpacity: 0.1, interactive: false } }).addTo(worldLayer);
        });

    function normalizeName(str) {
        if (!str) return "";
        return str.toString().toLowerCase().trim()
            .replace(/ƒü/g, "g").replace(/√º/g, "u").replace(/≈ü/g, "s")
            .replace(/ƒ±/g, "i").replace(/√∂/g, "o").replace(/√ß/g, "c")
            .replace(/\s+/g, "");
    }

    function getColor(d) {
        const palette = PALETTES[selectedPaletteKey];
        if (d === 0 || d === null || d === undefined) return '#f1f1f1';
        for (let i = 0; i < userRanges.length; i++) {
            if (d <= userRanges[i]) return palette[i] || palette[palette.length-1];
        }
        return palette[palette.length - 1];
    }

    // --- YENƒ∞: Harita A√ßƒ±klamalarƒ± Paneli (Sol Alt) ---
    function updateDescriptionPanel() {
        if (descriptionControl) map.removeControl(descriptionControl);
        
        descriptionControl = L.control({ position: 'bottomleft' });
        descriptionControl.onAdd = function() {
            const div = L.DomUtil.create('div', 'info description');
            const title = document.getElementById('panelTitleInput').value || "Harita A√ßƒ±klamalarƒ±";
            
            // Verileri b√ºy√ºkl√ºƒüe g√∂re sƒ±rala ve ilk 5'i al
            const sortedEntries = Object.entries(currentData)
                .filter(entry => entry[1] > 0)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);

            let listItems = sortedEntries.map((entry, index) => {
                // G√∂rsel isim d√ºzeltme (ilk harf b√ºy√ºk)
                const name = entry[0].charAt(0).toUpperCase() + entry[0].slice(1);
                return `<li><span>${index + 1}. ${name}</span> <b>${entry[1]}</b></li>`;
            }).join('');

            if (sortedEntries.length === 0) listItems = "<li>Veri girilmedi</li>";

            div.innerHTML = `<h4>${title}</h4><ul>${listItems}</ul>`;
            return div;
        };
        descriptionControl.addTo(map);
    }

    function updateLegend() {
        if (legendControl) map.removeControl(legendControl);
        legendControl = L.control({ position: 'bottomright' });
        legendControl.onAdd = function () {
            const div = L.DomUtil.create('div', 'info legend');
            const palette = PALETTES[selectedPaletteKey];
            let labels = ['<i style="background:#f1f1f1"></i> 0'];
            for (let i = 0; i < userRanges.length; i++) {
                let from = userRanges[i-1] ? userRanges[i-1] + 1 : 1;
                let to = userRanges[i];
                labels.push('<i style="background:' + palette[i] + '"></i> ' + from + (to ? ' &ndash; ' + to : '+'));
            }
            labels.push('<i style="background:' + palette[userRanges.length] + '"></i> ' + (userRanges[userRanges.length-1] + 1) + '+');
            div.innerHTML = labels.join('<br>');
            return div;
        };
        legendControl.addTo(map);
    }

    function loadTurkeyGeoJSON() {
        fetch('https://raw.githubusercontent.com/MEnesSevgi/altlik-harita/main/tr-cities-utf8.json')
            .then(res => res.json())
            .then(geojson => {
                turkeyLayerGroup.clearLayers();
                L.geoJSON(geojson, {
                    style: (feature) => {
                        const name = feature.properties.NAME || feature.properties.name || "";
                        const val = currentData[normalizeName(name)] || 0;
                        return { fillColor: getColor(val), weight: 1.5, opacity: 1, color: '#666', fillOpacity: 0.8 };
                    },
                    onEachFeature: (f, l) => {
                        const name = f.properties.NAME || f.properties.name || "Bilinmiyor";
                        const val = currentData[normalizeName(name)] || 0;
                        l.bindPopup(`<b>${name}</b><br>Deƒüer: ${val}`);
                        const center = l.getBounds().getCenter();
                        L.marker(center, {
                            icon: L.divIcon({
                                className: 'city-label',
                                html: `<span>${name}</span>`,
                                iconSize: [60, 20]
                            }),
                            interactive: false
                        }).addTo(turkeyLayerGroup);
                    }
                }).addTo(turkeyLayerGroup);
                updateLegend();
                updateDescriptionPanel(); // Panel g√ºncellenir
            });
    }

    function updateRangesFromUI() {
        const inputs = document.querySelectorAll('.range-val:not(#panelTitleInput)');
        userRanges = Array.from(inputs).map(i => parseFloat(i.value)).filter(v => !isNaN(v)).sort((a,b) => a-b);
    }

    const provinceList = ["Adana", "Adƒ±yaman", "Afyonkarahisar", "Aƒürƒ±", "Amasya", "Ankara", "Antalya", "Artvin", "Aydƒ±n", "Balƒ±kesir", "Bilecik", "Bing√∂l", "Bitlis", "Bolu", "Burdur", "Bursa", "√áanakkale", "√áankƒ±rƒ±", "√áorum", "Denizli", "Diyarbakƒ±r", "Edirne", "Elazƒ±ƒü", "Erzincan", "Erzurum", "Eski≈üehir", "Gaziantep", "Giresun", "G√ºm√º≈ühane", "Hakkari", "Hatay", "Isparta", "Mersin", "ƒ∞stanbul", "ƒ∞zmir", "Kars", "Kastamonu", "Kayseri", "Kƒ±rklareli", "Kƒ±r≈üehir", "Kocaeli", "Konya", "K√ºtahya", "Malatya", "Manisa", "Kahramanmara≈ü", "Mardin", "Muƒüla", "Mu≈ü", "Nev≈üehir", "Niƒüde", "Ordu", "Rize", "Sakarya", "Samsun", "Siirt", "Sinop", "Sivas", "Tekirdaƒü", "Tokat", "Trabzon", "Tunceli", "≈ûanlƒ±urfa", "U≈üak", "Van", "Yozgat", "Zonguldak", "Aksaray", "Bayburt", "Karaman", "Kƒ±rƒ±kkale", "Batman", "≈ûƒ±rnak", "Bartƒ±n", "Ardahan", "Iƒüdƒ±r", "Yalova", "Karab√ºk", "Kilis", "Osmaniye", "D√ºzce"];

    function setup() {
        const container = document.getElementById('provinceInputs');
        provinceList.sort((a,b) => a.localeCompare('tr')).forEach(p => {
            const div = document.createElement('div');
            div.className = 'province-entry';
            div.innerHTML = `<label>${p}</label><input type="number" id="input-${normalizeName(p)}" name="${p}" value="0">`;
            container.appendChild(div);
        });

        Object.keys(PALETTES).forEach(k => {
            const s = document.createElement('span');
            s.className = `color-option ${k === selectedPaletteKey ? 'selected' : ''}`;
            s.style.background = PALETTES[k][4];
            s.onclick = () => {
                document.querySelectorAll('.color-option').forEach(el => el.classList.remove('selected'));
                s.classList.add('selected');
                selectedPaletteKey = k;
                updateChoropleth();
            };
            document.getElementById('colorPaletteSelector').appendChild(s);
        });
    }

    function updateChoropleth() {
        updateRangesFromUI();
        document.querySelectorAll('#provinceInputs input').forEach(i => {
            currentData[normalizeName(i.name)] = parseFloat(i.value) || 0;
        });
        loadTurkeyGeoJSON();
    }

    document.getElementById('updateButton').onclick = updateChoropleth;

    // Excel i≈ülemleri
    document.getElementById('downloadTemplate').onclick = () => {
        const data = provinceList.map(p => ({ "IL_ADI": p, "VERI_DEGERI": 0 }));
        const ws = XLSX.utils.json_to_sheet(data);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Veri");
        XLSX.writeFile(wb, "Harita_Sablon.xlsx");
    };

    document.getElementById('uploadData').onclick = () => document.getElementById('excelFile').click();
    document.getElementById('excelFile').onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const wb = XLSX.read(new Uint8Array(ev.target.result), {type: 'array'});
            const json = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
            json.forEach(row => {
                const il = row["IL_ADI"] || Object.values(row)[0];
                const val = row["VERI_DEGERI"] || Object.values(row)[1];
                const input = document.getElementById(`input-${normalizeName(il)}`);
                if(input) input.value = val || 0;
            });
            updateChoropleth();
        };
        reader.readAsArrayBuffer(e.target.files[0]);
    };

    document.getElementById('shareMap').onclick = () => {
        updateRangesFromUI();
        const params = new URLSearchParams();
        params.set('view', '1');
        params.set('palette', selectedPaletteKey);
        params.set('ranges', userRanges.join(','));
        params.set('title', document.getElementById('panelTitleInput').value);
        params.set('data', btoa(unescape(encodeURIComponent(JSON.stringify(currentData)))));
        navigator.clipboard.writeText(window.location.origin + window.location.pathname + '?' + params.toString());
        alert("Baƒülantƒ± kopyalandƒ±! (Panel ba≈ülƒ±ƒüƒ± dahil edildi)");
    };

    function checkUrlParams() {
        const urlParams = new URLSearchParams(window.location.search);
        if (urlParams.get('view') === '1') document.body.classList.add('view-mode');
        if (urlParams.get('title')) document.getElementById('panelTitleInput').value = urlParams.get('title');
        if (urlParams.get('palette')) selectedPaletteKey = urlParams.get('palette');
        if (urlParams.get('ranges')) {
            userRanges = urlParams.get('ranges').split(',').map(Number);
            const rangeInputs = document.querySelectorAll('.range-val:not(#panelTitleInput)');
            userRanges.forEach((rv, i) => { if(rangeInputs[i]) rangeInputs[i].value = rv; });
        }
        if (urlParams.get('data')) {
            try {
                currentData = JSON.parse(decodeURIComponent(escape(atob(urlParams.get('data')))));
                setTimeout(() => {
                    Object.keys(currentData).forEach(key => {
                        const input = document.getElementById(`input-${key}`);
                        if(input) input.value = currentData[key];
                    });
                    loadTurkeyGeoJSON();
                }, 800);
            } catch(e) { console.error(e); }
        }
    }

    setup();
    checkUrlParams();
    loadTurkeyGeoJSON();
</script>
</body>
</html>
